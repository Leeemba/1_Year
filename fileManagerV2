package Managers;
import ConsoleOperations.*;
import ConsoleOperations.Console;
import Exceptions.ExitPoint;
import Exceptions.InvalidFormException;
import Managers.Converter.CompactQueueConverter;
import Models.Organization;
import com.thoughtworks.xstream.*;
import com.thoughtworks.xstream.converters.ConversionException;
import com.thoughtworks.xstream.io.StreamException;
import com.thoughtworks.xstream.security.AnyTypePermission;


import java.io.*;
import java.nio.charset.StandardCharsets;
import java.util.ArrayDeque;

public class FileManager {
    private String text;
    private XStream xStream = new XStream();
    private Printable console;
    private UserInput input;
    private CollectionManager collectionManager;



    public FileManager(Console console,CollectionManager collectionManager) {

        this.console = console;


        this.xStream.alias("Organization", Organization.class);
        this.xStream.alias("Collection",ArrayDeque.class);
        this.xStream.addPermission(AnyTypePermission.ANY);
        this.xStream.registerConverter(new CompactQueueConverter(xStream.getMapper()));
        //this.xStream.addImplicitCollection(CollectionManager.class, "collection");
        /*this.xStream.allowTypesByWildcard(new String[]{"java.util.ArrayDeque"});*/
        this.collectionManager = collectionManager;
    }



    public void findFile() throws ExitPoint {
        var input = new ConsoleInput();
        String filePath = input.userInputNextLine();
        if (filePath == null || filePath.isBlank()){
            console.printErr("Отсутствует пользовательский ввод для указания пути к файлу!");
            throw new ExitPoint();
        }

        File file = new File(filePath);
        StringBuilder sb = new StringBuilder();
        int b;

        try (InputStreamReader isr = new InputStreamReader(new FileInputStream(file) )){
        while ((b = isr.read())!=-1){
            sb.append((char) b);
        }
        console.println(ConsoleFormat.coloring("Путь к файлу успешно получен!",ConsoleFormat.GREEN,ConsoleFormat.ITALIC));

        if(sb.isEmpty()){
            console.printErr("Файл пустой");
            this.text = "[]";
            return;
        }
        this.text=sb.toString();
        }catch (FileNotFoundException e){
            console.printErr("Файл не найден!");
            throw new ExitPoint();
        }catch (IOException e){
            console.printErr("Ошибка ввода/вывода: "+ e);
        }
    }



    public void createObject() throws ExitPoint{
        try {
            ArrayDeque<Organization> collectionFromXml = (ArrayDeque<Organization>) xStream.fromXML(this.text);

            for (Organization org:collectionFromXml) {
                if(this.collectionManager.checkExist(org.getId())){
                    console.printErr("В файле повторяются \"id\"");
                    throw new ExitPoint();
                }
                this.collectionManager.addElement(org);
            }
        }catch (InvalidFormException | ConversionException| StreamException  e){
            console.printErr("Невалидные поля объекта");
        }
        Organization.updateNextId(collectionManager.getCollection());
    }


    public void saveObjects() {
        var input = new ConsoleInput();
        String filePath = input.userInputNextLine();
        if (filePath == null || filePath.isBlank()) console.printErr("Отсутствует пользовательский ввод для указания пути к файлу!");
        try (OutputStreamWriter osw = new OutputStreamWriter(new FileOutputStream(filePath),StandardCharsets.UTF_8)){
            osw.write((this.xStream.toXML(collectionManager.getCollection())));
            console.println(ConsoleFormat.coloring("Путь к файлу успешно получен!",ConsoleFormat.GREEN,ConsoleFormat.ITALIC));
        }catch (FileNotFoundException e){
            console.printErr("Файл не найден!");
        }catch (IOException e){
            console.printErr("Ошибка ввода/вывода");
        }


    }




}
